<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Theme Made By www.w3schools.com - No Copyright -->
  <title>CrowdSource</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script> -->
  <link rel="stylesheet" href="style.css">

  <style>
    body {
      font: 20px Montserrat, sans-serif;
      line-height: 1.8;
      color: #f5f6f7;
  }
  p {font-size: 16px;}
  .margin {margin-bottom: 45px;}
  .bg-1 { 
      background-color: #1abc9c; /* Green */
      color: #ffffff;
  }
  .bg-2 { 
      background-color: #474e5d; /* Dark Blue */
      color: #ffffff;
      width:100%;
  }
  .bg-3 { 
      background-color: #ffffff; /* White */
      color: #555555;
  }
  .bg-5 { 
    background-color: #4CAF50; /* White */
    color: rgb(12, 9, 9);
}
  .bg-4 { 
      background-color: #2f2f2f; /* Black Gray */
      color: #fff;
  }
  .arrange-horizontally > * {
    display: inline-block;
    text-align: center;
    border-style: dotted;
  }
  .arrange-vertically > * {
    display: block;
  }
  
  .container-fluid {
      padding-top: 70px;
      padding-bottom: 70px;
  }
  .navbar {
      padding-top: 10px;
      padding-bottom: 10px;
      border: 0;
      border-radius: 0;
      margin-bottom: 0;
      font-size: 12px;
      letter-spacing: 5px;
  }
  .navbar-nav  li a:hover {
      color: #1abc9c !important;
  }
  div.block{
    border-style: dotted;
    display: inline-block;
  }
  .button {
    border: none;
    color: black;
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
    
}
  </style>
</head>

<body onload="displayTransactions()">

  <!-- Navbar -->
  <nav class="navbar navbar-inverse">
      <div class="navbar">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">CrowdSource</a>
        </div>
        <ul class="nav navbar-nav navbar-right ">
          <li class="active"><a href="#dashboard">Dashboard</a></li>
          <li><a href="#new">New</a></li>
          <li><a href="#about">About</a></li>
        </ul>
      </div>
    </nav>
  <!-- Second Container -->
  
  <!-- Third Container (Grid) -->
  <div id="dashboard" class="container-fluid bg-3 text-center">
    <h3 class="margin">Dashboard</h3><br>
    <div id="contracts" >
      
    </div>
  </div>

  
  <!-- First Container -->
  <div id="new" class="container bg-5 text-center">
    <h3 >Fresh Project</h3><br>

    <div id="contact">
      <fieldset>
        <input name="name" placeholder="Name of Project Maker" type="text" tabindex="2" required>
      </fieldset>
      <fieldset>
        <input name="goal" placeholder="Goal in Wei" type="number" tabindex="3" min=0 required>
      </fieldset>
      <fieldset>
        <input name="dead" placeholder="Deadline (Number of Hours)" type="number" tabindex="4" min=1 required>
      </fieldset>
      <fieldset>
        <button name="submit" type="submit" id="contact-submit" data-submit="...Sending" onclick="submitform()">Submit</button>
      </fieldset>
    </div>
  </div>
  <div id="about" class="container-fluid bg-2 text-center">
      <h3 class="margin">About</h3>
      <p>A platform to crowdsource projects initiated by anyone! Grid dashboard to view available
        projects. Create new projects and begin collecting funds to reach a goal within a deadline!
      </p>
      <img src="crowdsourcing-cartoon.jpg" class="img-responsive img-circle margin" style="display:inline" alt="Bird" width="350" height="350">
  
  </div>

  <script type="text/javascript">
const MyAbi = [
  {
    inputs: [
      { name: "_goal", type: "uint256" },
      { name: "_timelimit", type: "uint256" }
    ],
    payable: true,
    stateMutability: "payable",
    type: "constructor"
  },
  {
    anonymous: false,
    inputs: [
      { indexed: true, name: "funder", type: "address" },
      { indexed: false, name: "totalFunders", type: "uint256" }
    ],
    name: "ParticipateLogger",
    type: "event"
  },
  {
    anonymous: false,
    inputs: [{ indexed: false, name: "beneficiary", type: "address" }],
    name: "FinalizeLogger",
    type: "event"
  },
  {
    constant: false,
    inputs: [],
    name: "participate",
    outputs: [{ name: "", type: "uint256" }],
    payable: true,
    stateMutability: "payable",
    type: "function"
  },
  {
    constant: true,
    inputs: [],
    name: "effectivegoal",
    outputs: [{ name: "", type: "int256" }],
    payable: false,
    stateMutability: "view",
    type: "function"
  },
  {
    constant: false,
    inputs: [],
    name: "finalize",
    outputs: [],
    payable: false,
    stateMutability: "nonpayable",
    type: "function"
  },
  {
    constant: false,
    inputs: [],
    name: "refund",
    outputs: [],
    payable: false,
    stateMutability: "nonpayable",
    type: "function"
  }
];
var MyContract = web3.eth.contract(MyAbi);
var defAccount = web3.eth.accounts[0];

window.addEventListener("load", async () => {
  // Modern dapp browsers...
  if (window.ethereum) {
    window.web3 = new Web3(ethereum);
    try {
      // Request account access if needed
      await ethereum.enable();

      defAccount = web3.eth.accounts[0];
      // Acccounts now exposed
      // web3.eth.sendTransaction({/* ... */});
    } catch (error) {
      alert("Please Allow MetaMask");
      // User denied account access...
    }
  }
  // Legacy dapp browsers...
  else if (window.web3) {
    window.web3 = new Web3(web3.currentProvider);
    // Acccounts always exposed
    // web3.eth.sendTransaction({/* ... */});
  }
  // Non-dapp browsers...
  else {
    console.log(
      "Non-Ethereum browser detected. You should consider trying MetaMask!"
    );
  }
});

function fundTransaction(address){
  console.log(address)
}

function displayTransactions(){
  $.get(
        "http://localhost:8080/get_data",
        function(data) {
          var j = 0;
          var temp = "";
          for(var i in data){
            console.log(data[i], j)
            var address = data[i]["Address"]
            var c = web3.eth.contract(MyAbi).at(address)
            console.log(c)

            // var goal = c.effectivegoal()
            // console.log(goal)
            if(i%3 == 0)
              temp += "<div class=\"row\"><div class=\"col-sm-4 block\">";
            else
              temp += "<div class=\"col-sm-4 block\">";
            
            temp += "<p> Project\ Owner - " + data[i]['name'] + "</p><p>Goal - </p><p>Effecitve Goal - </p><p>Number of Funders - </p>";
            temp += "<button class=\"button\" name=\"submit\" type=\"submit\" onClick=\"fundTransaction()\">Fund</button></div>";

            if(i%3 == 2)
              temp += "</div>";
            
          }
          document.getElementById("contracts").innerHTML = temp;
          console.log(document.getElementById("contracts").innerHTML)
          
          // alert("Load was performed.");
        },
        "json"
      );

}

var contractInstance;

function submitform() {
  
  var name = $("input[name=name]").val();
  var goal = $("input[name=goal]").val();
  // var Address = $("input[name=Add]").val();
  var Deadline = $("input[name=dead]").val();
  contractInstance = MyContract.new(
    web3.toWei(goal, "wei"),
    Deadline * 60 * 60,
    { from: defAccount, gas: 2000000 },
    function(err, myContract) {
      console.log("CallBack")
      console.log(myContract)
      if(!err) {
        if(!myContract.address) {
            var x =(myContract.transactionHash); // The hash of the transaction, which deploys the contract
            alert("contractCreated")
        // check address on the second call (contract deployed)
        } else {
          alert("contract deployed")
            var x = myContract.address; // the contract address
        console.log(x)
        $.post(
          "http://localhost:8080/data", // url
          { Address: x, name: name }, // data to be submit
          function(data, status, jqXHR) {
            // success callback
            console.log(data);
            console.log(status);
          },
          "json"
        );
        }
      }
        else{
         console.log(err);
        }
    }
  );
}
</script>
</body>

</html>